#
# Azure Pipelines for LibreCAD builds
#


# Branches to monitor
trigger:
- master
- play_with_azure


# Don't run on pull requests
pr: none


stages:

- stage: Build
  displayName: 'Build for all architectures'


  jobs:

  - job: LinuxBuild
    displayName: 'Linux Build'
    condition: False  # disable this job for now

    pool:
      vmImage: 'ubuntu-16.04'

    steps:

    - bash: |
        sudo apt-get -qq install \
            qt5-default \
            qtbase5-dev  \
            libqt5svg5-dev \
            qttools5-dev \
            qttools5-dev-tools \
            libmuparser-dev \
            libboost-dev \
            libfreetype6-dev \
            libicu-dev \
            pkg-config
      displayName: 'Install dependencies'

    - bash: |
        qmake -r librecad.pro CONFIG+=debug_and_release
        make release -j$(nproc)
      displayName: 'Build from source'

    - bash: |
        ./scripts/build-appimage.sh
        ls -lh ./AppImage/
      displayName: 'Build AppImage'

    - task: CopyFiles@2
      inputs:
        contents: 'AppImage/*.AppImage'
        targetFolder: $(Build.ArtifactStagingDirectory)

    - task: PublishBuildArtifacts@1
      inputs:
        pathToPublish: $(Build.ArtifactStagingDirectory)
        artifactName: AppImage


  - job: WindowsBuild
    displayName: 'Windows Build'
    condition: False  # disable this job for now

    pool:
      vmImage: 'vs2017-win2016'

    steps:

    - bash: |
        echo 'Dependencies: TODO'
      displayName: 'Install dependencies'

    - bash: |
        echo 'Build: TODO'
      displayName: 'Build from source'

    - task: CopyFiles@2
      inputs:
        contents: '*.exe'
        targetFolder: $(Build.ArtifactStagingDirectory)

    - task: PublishBuildArtifacts@1
      inputs:
        pathToPublish: $(Build.ArtifactStagingDirectory)
        artifactName: WindowsInstaller


  - job: MacOSBuild
    displayName: 'MacOS Build'

    pool:
      vmImage: 'macos-10.14'

    steps:

    - bash: |
        #wget https://github.com/macports/macports-base/releases/download/v2.5.4/MacPorts-2.5.4-10.13-HighSierra.pkg
        #sudo installer -pkg ./MacPorts-2.5.4-10.13-HighSierra.pkg -target /
        #export PATH=/opt/local/bin:/opt/local/sbin:$PATH
        #sudo port install \
        #    gcc8 \
        #    qt5-qtcreator \
        #    boost \
        #    freetype
        #sudo port select --set gcc mp-gcc8
        gcc --version
        brew install qt5
        brew link qt5 --force
        brew install boost
        brew install freetype
        brew install gcc@9
      displayName: 'Install dependencies'

    - bash: |
        printenv
        echo '===='
        export PATH="/usr/local/opt/qt/bin:$PATH"
        export LDFLAGS="-L/usr/local/opt/qt/lib"
        export CPPFLAGS="-I/usr/local/opt/qt/include"
        export PATH="/usr/local/opt/icu4c/bin:$PATH"
        export PATH="/usr/local/opt/icu4c/sbin:$PATH"
        export LDFLAGS="-L/usr/local/opt/icu4c/lib $LDFLAGS"
        export CPPFLAGS="-I/usr/local/opt/icu4c/include $CPPFLAGS"
        echo '===='
        printenv
        gcc --version
        echo "QT_CONFIG -= no-pkg-config" >> custom.pro
        qmake librecad.pro -r -spec macx-g++ CONFIG+=debug_and_release
        #qmake librecad.pro -r -spec macx-clang CONFIG+=debug_and_release
        make release -j$(sysctl -n hw.ncpu)
        ls -lah
        ls -laRh LibreCAD.app
      displayName: 'Build from source'

    - task: CopyFiles@2
      inputs:
        contents: '*.dmg'
        targetFolder: $(Build.ArtifactStagingDirectory)

    - task: PublishBuildArtifacts@1
      inputs:
        pathToPublish: $(Build.ArtifactStagingDirectory)
        artifactName: MacOSPackage


- stage: Upload
  displayName: 'Upload built files'

  jobs:

  - job: UploadFiles
    displayName: 'Upload built files'
    condition: False  # disable this job for now

    pool:
        vmImage: 'ubuntu-16.04'

    steps:

    - bash: |
        echo 'TODO'
      displayName: 'Upload TODO'

